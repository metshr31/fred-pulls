name: Scheduled Transcript Daily Scrape

on:
  # Run at 2:00 AM Eastern Time daily (7:00 AM UTC)
  schedule:
    - cron: '0 7 * * *' 
  # Allows manual run from the Actions tab
  workflow_dispatch:

jobs:
  scrape:
    runs-on: ubuntu-latest
    
    # FIX: Grant explicit write permission for the bot to push changes
    permissions:                  
      contents: write             
    
    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: ðŸ“¦ Install dependencies
        run: |
          # Install Python dependencies
          pip install playwright beautifulsoup4 python-dateutil
          # Install the necessary browsers for Playwright (Chromium is bundled)
          playwright install chromium --with-deps

      - name: âš™ï¸ Run the scraper script
        id: run-script
        run: |
          # Determine yesterday's date (since the cron runs early UTC for US data)
          TARGET_DATE=$(date -u --date 'yesterday' +%Y-%m-%d)
          echo "Scraping transcripts for: $TARGET_DATE"
          
          # Use the Playwright script
          python scrape_investing_transcripts_playwright.py --date $TARGET_DATE --out transcripts.txt
          
          # Expose the date as an output variable for the commit message
          echo "date=$TARGET_DATE" >> $GITHUB_OUTPUT 

      - name: ðŸ“¤ Commit and push results
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ðŸ¤– Daily scrape update for ${{ steps.run-script.outputs.date }}"
          # Only commit the output file
          file_pattern: transcripts.txt
          # The GITHUB_TOKEN now has 'write' permission granted above
          token: ${{ secrets.GITHUB_TOKEN }}
